"use strict";var __importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0});var fs_1=__importDefault(require("fs")),jsonfile_1=__importDefault(require("jsonfile")),path_1=__importDefault(require("path")),utils_1=require("./utils");require("colors");var readMatrixJSON=function(t,e,r){var i=path_1.default.join(utils_1.getMatrixFolder(t),e,r+".json");return fs_1.default.existsSync(i)&&fs_1.default.statSync(i).isFile()?jsonfile_1.default.readFileSync(i,{encoding:"UTF-8"}):null},readMatrix=function(t,e){var r=t.story,i=t.flow,n=readMatrixJSON(e,r,i)||[];return 0==n.length?[{story:r,flow:i}]:n.map(function(t){return jsonfile_1.default.writeFileSync(utils_1.getMatrixDataFile(e,r,i,t.key),t,{encoding:"UTF-8",spaces:"\t"}),{story:r,flow:"matrix:"+i+"?"+t.key}})};exports.findFlows=function(r){if(r.isOnChildProcess())return[r.getFlowFileInChildProcess()];var i=r.getWorkspace();return fs_1.default.readdirSync(i).filter(function(t){return fs_1.default.statSync(path_1.default.join(i,t)).isDirectory()}).filter(function(t){return![".scripts"].includes(t)}).map(function(e){return fs_1.default.readdirSync(path_1.default.join(i,e)).filter(function(t){return fs_1.default.statSync(path_1.default.join(i,e,t)).isFile()}).filter(function(t){return t.endsWith(".flow.json")}).map(function(t){return t.replace(/^(.*)\.flow\.json$/,"$1")}).filter(function(t){return r.isIncluded(e,t)&&!r.isExcluded(e,t)}).map(function(t){return{story:e,flow:t}}).reduce(function(t,e){return t.push.apply(t,readMatrix(e,r)),t},[])}).reduce(function(t,e){return t.push.apply(t,e),t},[])};