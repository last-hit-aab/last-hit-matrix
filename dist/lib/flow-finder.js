"use strict";var __spreadArrays=this&&this.__spreadArrays||function(){for(var e=0,r=0,t=arguments.length;r<t;r++)e+=arguments[r].length;var n=Array(e),i=0;for(r=0;r<t;r++)for(var a=arguments[r],o=0,s=a.length;o<s;o++,i++)n[i]=a[o];return n},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var fs_1=__importDefault(require("fs")),jsonfile_1=__importDefault(require("jsonfile")),path_1=__importDefault(require("path")),utils_1=require("./utils");require("colors");var readMatrixJSON=function(e,r,t){var n=path_1.default.join(utils_1.getMatrixFolder(e),r,t+".json");return fs_1.default.existsSync(n)&&fs_1.default.statSync(n).isFile()?jsonfile_1.default.readFileSync(n,{encoding:"UTF-8"}):null},readMatrix=function(e,r){var t=e.story,n=e.flow,i=readMatrixJSON(r,t,n)||[];return 0==i.length?[{story:t,flow:n}]:i.map(function(e){return jsonfile_1.default.writeFileSync(utils_1.getMatrixDataFile(r,t,n,e.key),e,{encoding:"UTF-8",spaces:"\t"}),{story:t,flow:"matrix:"+n+"?"+e.key}})},generateKeyByString=function(e,r){return"["+r+"@"+e+"]"},checkNecessary=function(e,c){var d={},r=e.map(function(e){return d[generateKeyByString(e.story,e.flow)]=e}).reduce(function(a,e){var r=c.readFlowFile(e.story,e.flow).settings,t=void 0===r?{forceDepends:void 0,dataDepends:void 0}:r,n=t.forceDepends,i=t.dataDepends,o=void 0===i?[]:i;if(n){var s=n.story,f=n.flow,u=generateKeyByString(s,f);if(!d[u]){var l={story:s,flow:f};a.push(l),d[u]=l}}return o.forEach(function(e){var r=e.story,t=e.flow,n=generateKeyByString(r,t);if(!d[n]){var i={story:r,flow:t};a.push(i),d[n]=i}}),a.forEach(function(e){var r=utils_1.getOriginalFlow(e.flow);if(r.matrixed){var t=utils_1.getMatrixDataFile(c,e.story,r.flow,r.matrixKey);fs_1.default.existsSync(t)||readMatrix({story:e.story,flow:r.flow},c)}}),a},[]);return __spreadArrays(r,e)};exports.findFlows=function(t){if(t.isOnChildProcess())return[t.getFlowFileInChildProcess()];for(var n=t.getWorkspace(),e=fs_1.default.readdirSync(n).filter(function(e){return fs_1.default.statSync(path_1.default.join(n,e)).isDirectory()}).filter(function(e){return![".scripts",".matrix"].includes(e)}).map(function(r){return fs_1.default.readdirSync(path_1.default.join(n,r)).filter(function(e){return fs_1.default.statSync(path_1.default.join(n,r,e)).isFile()}).filter(function(e){return e.endsWith(".flow.json")}).map(function(e){return e.replace(/^(.*)\.flow\.json$/,"$1")}).filter(function(e){return t.isIncluded(r,e)&&!t.isExcluded(r,e)}).map(function(e){return{story:r,flow:e}}).reduce(function(e,r){return e.push.apply(e,readMatrix(r,t)),e},[])}).reduce(function(e,r){return e.push.apply(e,r),e},[]),r=checkNecessary(e,t);;){var i=checkNecessary(r,t);if(i.length===r.length)break;r=i}return r};